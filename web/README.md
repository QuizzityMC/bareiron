# Bareiron WebAssembly Version

This directory contains the browser-based version of the Bareiron Minecraft server.

## Quick Start

### Building

1. **Install Emscripten SDK:**
   ```bash
   # Clone emsdk
   git clone https://github.com/emscripten-core/emsdk.git
   cd emsdk
   
   # Install and activate
   ./emsdk install latest
   ./emsdk activate latest
   source ./emsdk_env.sh
   ```

2. **Generate Registry Data:**
   From the bareiron root directory:
   ```bash
   ./extract_registries.sh
   # OR follow manual instructions in main README.md
   ```

3. **Build the WebAssembly Module:**
   ```bash
   ./build_wasm.sh
   ```

   This will generate:
   - `web/bareiron.js` - Emscripten-generated JavaScript
   - `web/bareiron.wasm` - WebAssembly binary
   - `web/bareiron.data` - Asset files (if any)

### Running

1. **Start a Local Web Server:**
   ```bash
   # Using Python
   cd web
   python3 -m http.server 8080
   
   # OR using Node.js
   npx http-server . -p 8080
   ```

2. **Open in Browser:**
   Navigate to `http://localhost:8080` in Chrome, Edge, or Firefox.

3. **Start the Server:**
   Click the "Start Server" button in the web interface.

## Connecting Minecraft Clients

Due to browser security restrictions, Minecraft clients cannot connect directly to the WebSocket server running in your browser. You need to use a proxy.

### Option 1: WebSocket-to-TCP Proxy

Install and run a proxy tool:

```bash
# Install ws-tcp-relay
npm install -g ws-tcp-relay

# Run the proxy
ws-tcp-relay --listen 25565 --target ws://localhost:8080
```

Then connect your Minecraft client to `localhost:25565`.

### Option 2: Use the Included Proxy Server

This repository includes a ready-to-use proxy server:

```bash
# Install dependencies
cd web
npm install

# Run the proxy
npm run proxy

# Or directly:
node proxy-server-example.js
```

The proxy will listen on port 25565 for Minecraft clients and forward to the WebSocket server.

### Option 3: Custom Proxy Server

You can create a custom Node.js proxy. See `proxy-server-example.js` for a complete implementation.

## Files

- **index.html** - Web interface for the server
- **bareiron-bridge.js** - JavaScript bridge between browser and WASM
- **bareiron.js** - Generated by Emscripten (after build)
- **bareiron.wasm** - Compiled WebAssembly module (after build)

## Limitations

### Browser Environment

- **No Native TCP**: Browsers don't support raw TCP sockets, only WebSockets
- **Memory Limits**: Typically 2-4 GB depending on browser and system
- **No File System**: World data is stored in memory only (lost on page refresh)
- **Performance**: Slower than native code, especially for world generation

### Workarounds

1. **World Persistence**: Use IndexedDB to save/load world data between sessions
2. **Performance**: Reduce view distance and player count in `globals.h`
3. **Memory**: Decrease `MAX_BLOCK_CHANGES` to reduce memory usage

## Configuration

Before building, edit `include/globals.h` to configure the server:

```c
// Recommended settings for WebAssembly
#define MAX_PLAYERS 4              // Fewer players
#define MAX_BLOCK_CHANGES 5000     // Less world data
#define VIEW_DISTANCE 2            // Keep at 2
#define TIME_BETWEEN_TICKS 1000000 // Default tick rate
```

## Troubleshooting

### Build Issues

**"emcc: command not found"**
- Make sure Emscripten is installed and activated
- Run `source /path/to/emsdk/emsdk_env.sh`

**"registries.h not found"**
- Generate registry data first: `./extract_registries.sh`
- Or follow manual steps in main README

### Runtime Issues

**"Failed to fetch bareiron.wasm"**
- Ensure you're serving files over HTTP, not file://
- Check that bareiron.wasm exists in the web directory

**"Cannot connect from Minecraft"**
- Make sure you're using a WebSocket proxy
- Check that the proxy is running and configured correctly
- Verify firewall isn't blocking connections

**"Page is slow/unresponsive"**
- Reduce MAX_PLAYERS and MAX_BLOCK_CHANGES
- Lower VIEW_DISTANCE in globals.h
- Try a different browser (Chrome generally performs best)

## Technical Details

### How It Works

1. The C server code is compiled to WebAssembly using Emscripten
2. A JavaScript bridge (`bareiron-bridge.js`) handles WebSocket connections
3. The WASM module uses a compatibility layer (`wasm_compat.c`) that maps BSD socket calls to WebSocket operations
4. The web interface (`index.html`) provides a UI for starting/stopping the server

### Architecture

```
[Minecraft Client] <--TCP--> [Proxy Server] <--WebSocket--> [Browser]
                                                                  |
                                                            [WebAssembly]
                                                                  |
                                                            [Server Logic]
```

### Performance Tips

- Use Chrome or Edge for best WASM performance
- Close other tabs to free up memory
- Disable browser extensions that might interfere
- Consider using --allow-memory-growth flag in build script

## Contributing

Improvements to the WebAssembly port are welcome! Areas for improvement:

- [ ] IndexedDB integration for world persistence
- [ ] Better WebSocket bridge implementation
- [ ] Built-in proxy server
- [ ] Performance optimizations
- [ ] Better error handling
- [ ] Service worker for offline support

See the main [README](../README.md) for contribution guidelines.
